# 安全测试指南

## 快速验证改动是否安全

### 1. 编译检查 ✅
```bash
cd src/Midjourney.API
dotnet build
```
**预期结果**：编译成功，无错误

### 2. 基本功能测试 ✅
- 提交一个简单任务，确保能正常完成
- 检查任务状态是否正确更新
- 检查日志是否有异常错误

### 3. 观察日志 ✅
运行后观察日志，应该看到：
- ✅ "准备检查信号量" - 正常
- ✅ "从普通队列取出任务" - 正常
- ✅ "开始执行任务" - 正常
- ⚠️ "队列中有任务但未执行" - 如果出现，说明有问题
- ⚠️ "任务在SUBMITTED状态超时" - 如果出现，说明有任务卡住

## 如果只想启用诊断日志（更保守）

如果您想先只启用诊断日志，暂时禁用提前超时检测，可以：

### 方法1：注释掉提前超时检测
找到第737-757行，注释掉：
```csharp
// ✅ 关键修复：SUBMITTED状态任务的提前超时检测
// if (info.Status == TaskStatus.SUBMITTED)
// {
//     var submittedElapsed = sw.ElapsedMilliseconds - submittedStartTime;
//     if (submittedElapsed > submittedTimeoutMs)
//     {
//         // ... 自动失败逻辑
//     }
// }
```

### 方法2：增加超时时间
如果2分钟太短，可以增加到5分钟：
```csharp
var submittedTimeoutMs = 5 * 60 * 1000; // 改为5分钟
```

## 回滚方案

如果出现问题，可以快速回滚：

### Git回滚（推荐）
```bash
git checkout HEAD -- src/Midjourney.Infrastructure/Services/DiscordInstance.cs
```

### 手动回滚
1. 删除所有标记为 `✅ 关键修复` 的代码块
2. 保留诊断日志（这些是安全的）

## 监控建议

### 第一周监控重点
1. **任务完成率**：是否正常
2. **队列处理速度**：是否正常
3. **日志中的警告**：关注"队列中有任务但未执行"的警告

### 如果出现以下情况，立即回滚
- ❌ 任务完成率明显下降
- ❌ 队列处理速度明显变慢
- ❌ 出现大量"任务在SUBMITTED状态超时"的错误

## 改动影响范围

- **影响范围**：只影响 `DiscordInstance.cs` 文件
- **影响功能**：任务执行和队列处理
- **破坏性**：无破坏性改动
- **向后兼容**：完全兼容

## 测试清单

- [ ] 编译成功
- [ ] 正常任务能完成
- [ ] 队列正常工作
- [ ] 日志无异常错误
- [ ] 卡住的任务能在2分钟后自动失败（如果启用提前超时）

